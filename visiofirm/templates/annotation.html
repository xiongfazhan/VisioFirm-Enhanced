{% extends "labeler_base.html" %}
{% block title %}{{ project_name }} - 标注{% endblock %}

{% block styles %}
<link rel="stylesheet" href="{{ url_for('static', filename='css/annotation.css') }}">
<link rel="stylesheet" href="{{ url_for('static', filename='css/setup.css') }}">
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.15.4/css/all.min.css">
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
{% endblock %}

{% block content %}
<!-- Grid View -->
    <div id="grid-view" class="view-container grid-view">
        <div class="grid-header">
            <div class="bulk-actions">
                <button class="grid-btn" id="select-all-btn" title="全选">
                    <i class="fas fa-check-square"></i> 全选
                </button>
                <button class="grid-btn" id="download-btn" title="下载未标注" disabled>
                    <i class="fas fa-download"></i> 下载
                </button>
                <button class="grid-btn" id="delete-images-btn" title="删除选中" disabled>
                    <i class="fas fa-trash"></i> 删除
                </button>
                <button class="grid-btn" id="import-images-btn" title="导入更多图片">
                    <i class="fas fa-upload"></i> 导入
                </button>
                <button class="grid-btn" id="export-btn" title="导出标注">
                    <i class="fas fa-file-export"></i> 导出
                </button>
            </div>
            <div class="grid-controls">
                <div class="dropdown">
                    <button id="sort-btn" class="layout-btn" title="重新排列列表">
                        <i class="fas fa-sort"></i> 排序
                    </button>
                    <div class="dropdown-content">
                        <a href="#" data-sort="name-asc">名称 (A-Z)</a>
                        <a href="#" data-sort="name-desc">名称 (Z-A)</a>
                        <a href="#" data-sort="date-asc">日期 (最旧优先)</a>
                        <a href="#" data-sort="date-desc">日期 (最新优先)</a>
                        <a href="#" data-sort="status-asc">完成度 (已标注优先)</a>
                        <a href="#" data-sort="status-desc">完成度 (未标注优先)</a>
                    </div>
                </div>
                <button id="grid-toggle-btn" class="layout-btn active" title="网格视图" data-view="grid">
                    <i class="fas fa-th"></i> 网格
                </button>
                <button id="list-toggle-btn" class="layout-btn" title="列表视图" data-view="list">
                    <i class="fas fa-list"></i> 列表
                </button>
            </div>
            <button id="ai-preannotator-btn" class="layout-btn ai-preannotator-btn" title="AI预标注器">
                <i class="fas fa-robot"></i> AI预标注器
            </button>
            <button id="ai-blind-trust" class="layout-btn ai-blind-trust" title="盲信任">
                <i class="fa-solid fa-fingerprint"></i> 盲信任
            </button>
            <button id="viewport-btn-grid" class="layout-btn" title="切换到视口模式">
                <i class="fas fa-desktop"></i> 标注
            </button>
        </div>
        <div class="grid-content">
            <div id="grid-thumbnails" class="grid-thumbnails">
                {% for image in images %}
                    <div class="grid-card" data-id="{{ image.split('/')[-1] }}" data-date="{{ '2023-01-01' }}" data-annotated="{% if image in annotated_images %}true{% else %}false{% endif %}" data-preannotated="{% if image in preannotated_images %}true{% else %}false{% endif %}">
                        <div class="card-checkbox">
                            <input type="checkbox" class="image-checkbox" data-path="{{ image }}">
                        </div>
                        <div class="card-image-container">
                            <img data-src="{{ image }}" alt="Thumbnail" class="lazy-load">
                            {% if image in annotated_images %}
                                <span class="annotated-check"><i class="fas fa-check"></i></span>
                            {% endif %}
                        </div>
                        <div class="card-info">
                            <span class="image-id">{{ loop.index0 }}</span>
                            <span class="image-date">{{ '2023-01-01' }}</span>
                            <span class="image-status" data-annotated="{% if image in annotated_images %}true{% else %}false{% endif %}" data-preannotated="{% if image in preannotated_images %}true{% else %}false{% endif %}">
                                {% if image in annotated_images %}
                                    已标注
                                {% elif image in preannotated_images %}
                                    预标注
                                {% else %}
                                    未标注
                                {% endif %}
                            </span>
                        </div>
                    </div>
                {% endfor %}
            </div>
        </div>
        <table id="list-table" class="list-table" style="display: none;">
            <thead>
                <tr>
                    <th>Select</th>
                    <th>ID</th>
                    <th>Preview</th>
                    <th>Date of Annotation</th>
                    <th>Completion</th>
                    <th>Annotator</th>
                </tr>
            </thead>
            <tbody>
                {% for image in images %}
                    <tr data-id="{{ loop.index0 }}" data-date="{{ '2023-01-01' }}" data-annotated="{% if image in annotated_images %}true{% else %}false{% endif %}" data-preannotated="{% if image in preannotated_images %}true{% else %}false{% endif %}" data-annotator="{% if image_annotators.get(image) %}{{ image_annotators[image] }}{% else %}null{% endif %}">
                        <td>
                            <input type="checkbox" class="image-checkbox" data-path="{{ image }}">
                        </td>
                        <td>{{ loop.index0 }}</td>
                        <td class="thumbnail-cell">
                            <div class="list-thumbnail-container">
                                <img data-src="{{ image }}" alt="Thumbnail" class="lazy-load">
                            </div>
                        </td>
                        <td>{{ '2023-01-01' }}</td>
                        <td class="image-status" data-annotated="{% if image in annotated_images %}true{% else %}false{% endif %}" data-preannotated="{% if image in preannotated_images %}true{% else %}false{% endif %}">
                            {% if image in annotated_images %}
                                Annotated
                            {% elif image in preannotated_images %}
                                Pre-Annotated
                            {% else %}
                                Not Annotated
                            {% endif %}
                        </td>
                        <td class="annotator-cell">
                            {% if image_annotators.get(image) %}
                                <div class="avatar">{{ image_annotators[image] }}</div>
                            {% else %}
                                -
                            {% endif %}
                        </td>
                    </tr>
                {% endfor %}
            </tbody>
        </table>
    </div>
    <!-- Annotation View -->
    <div id="annotation-view" class="view-container annotation-container hide">
        <div class="images-list">
            <div class="images-header">
                <h2>Images</h2>
                <button id="viewport-btn-annotation" class="layout-btn" title="切换到网格视图">
                    <i class="fas fa-th-large"></i> 网格视图
                </button>
            </div>
            <div class="thumbnails">
                <table class="thumbnail-table">
                    <tbody>
                        {% for image in images %}
                            <tr class="thumbnail-row" data-index="{{ loop.index0 }}" data-id="{{ image.split('/')[-1] }}">
                                <td class="thumbnail-id">{{ loop.index0 }}</td>
                                <td class="thumbnail-image">
                                    <img data-src="{{ image }}" alt="Thumbnail" class="lazy-load">
                                </td>
                            </tr>
                        {% endfor %}
                    </tbody>
                </table>
            </div>
        </div>
        <div class="labeling-area">
            <div class="image-workspace">
                <div class="image-container">
                    <div class="image-info"></div>
                    <canvas id="labeling-canvas"></canvas>
                    <div class="shortcuts-sidebar">
                        <button class="shortcuts-toggle" title="切换快捷键">
                            <i class="fas fa-keyboard"></i> 快捷键
                        </button>
                        <div class="shortcuts-content">
                            <div class="shortcuts-legend"></div>
                            <div class="shortcuts-list"></div>
                        </div>
                    </div>
                    <div class="canvas-controls">
                        <button class="control-btn" id="rect-mode" title="绘制矩形"><img src="{{ url_for('static', filename='img/logos/rect-mode.svg') }}" alt="绘制矩形"></button>
                        <button class="control-btn" id="polygon-mode" title="绘制多边形"><img src="{{ url_for('static', filename='img/logos/polygon-mode.svg') }}" alt="绘制多边形"></button>
                        <button class="control-btn" id="magic-mode" title="一键标注"><img src="{{ url_for('static', filename='img/logos/magic-mode.svg') }}" alt="一键标注"></button>
                        <button class="control-btn" id="select-mode" title="选择标签"><img src="{{ url_for('static', filename='img/logos/select-mode.svg') }}" alt="选择标签"></button>
                        <button class="control-btn" id="reset-view" title="重置视图"><img src="{{ url_for('static', filename='img/logos/reset-view.svg') }}" alt="重置视图"></button>
                        <button class="control-btn" id="undo-btn" title="撤销上一步操作"><img src="{{ url_for('static', filename='img/logos/undo-btn.svg') }}" alt="撤销上一步操作"></button>
                        <button class="control-btn" id="delete-btn" title="删除选中标注"><img src="{{ url_for('static', filename='img/logos/delete-btn.svg') }}" alt="删除选中标注"></button>
                        <button class="control-btn" id="zoom-in-btn" title="放大"><img src="{{ url_for('static', filename='img/logos/zoom-in-btn.svg') }}" alt="放大"></button>
                        <button class="control-btn" id="zoom-out-btn" title="缩小"><img src="{{ url_for('static', filename='img/logos/zoom-out-btn.svg') }}" alt="缩小"></button>
                        <button class="control-btn" id="duplicate-btn" title="复制选中标注"><img src="{{ url_for('static', filename='img/logos/duplicate-btn.svg') }}" alt="复制选中标注"></button>
                        <button class="control-btn" id="save-btn" title="保存标注"><img src="{{ url_for('static', filename='img/logos/save-btn.svg') }}" alt="保存标注"></button>
                        <button class="control-btn" id="grid-btn" title="切换网格"><img src="{{ url_for('static', filename='img/logos/grid-btn.svg') }}" alt="切换网格"></button>
                        <button class="control-btn" id="prev-image-btn" title="上一张图片"><img src="{{ url_for('static', filename='img/logos/prev-image-btn.svg') }}" alt="上一张图片"></button>
                        <button class="control-btn" id="next-image-btn" title="下一张图片"><img src="{{ url_for('static', filename='img/logos/next-image-btn.svg') }}" alt="下一张图片"></button>
                    </div>
                </div>
                <div class="ai-options">
                    <button id="hide-prediction-btn">隐藏预测</button>
                    <div class="confidence-slider">
                        <label for="confidence-slider">置信度: <span id="confidence-value">0.4</span></label>
                        <input type="range" id="confidence-slider" min="0" max="1" step="0.01" value="0.4" style="-webkit-appearance: slider-vertical; writing-mode: bt-lr; width: 8px; height: 100%;">
                    </div>
                </div>
            </div>
            <div class="control-panel">
                <div class="class-selector">
                    <div id="class-tags-container"></div>
                </div>
                <button class="approve-btn" id="approve-btn">批准</button>
            </div>
        </div>
    </div>
    <!-- Modals -->
    <div id="save-modal" class="modal">
        <div class="modal-content">
            <div class="save-icon">
                <svg class="checkmark" viewBox="0 0 52 52">
                    <circle class="checkmark-circle" cx="26" cy="26" r="25" fill="none"/>
                    <path class="checkmark-check" fill="none" d="M14.1 27.2l7.1 7.2 16.7-16.8"/>
                </svg>
            </div>
            <p class="save-message">标注保存成功！</p>
        </div>
    </div>
    <div class="modal" id="import-images-modal">
        <div class="modal-content">
            <button class="close-btn import-close-btn">×</button>
            <h2 class="modal-title">导入更多图片</h2>
            <form id="import-images-form" enctype="multipart/form-data">
                <div class="form-group">
                    <label class="import-label">为 <span class="project-name-highlight">{{ project_name }}</span> 导入图片</label>
                    <div class="drop-zone" id="import-images-drop-zone">
                        <i class="fa-solid fa-file-arrow-down drop-icon"></i>
                        <p>将图片/文件夹/压缩包拖拽到此处。</p>
                        <p><strong>支持的文件格式：</strong></p>
                        <p>图片：.webp, .jpg, .jpeg, .png, .avif</p>
                        <p>包含图片的压缩文件：.zip, .tar, .rar</p>
                        <p>图片文件夹</p>
                        <p id="import-images-compress-message" class="compress-message" style="display: none;">检测到压缩文件！将在提交时解压。</p>
                    </div>
                    <input type="file" id="import-images-file-input" name="files" multiple
                        accept=".webp,.WEBP,.jpg,.JPG,.jpeg,.JPEG,.png,.PNG,.avif,.AVIF,.zip,.ZIP,.tar,.TAR,.rar,.RAR"
                        style="display: none;" webkitdirectory directory>
                    <div id="import-images-file-list" class="file-list" style="display: none; max-height: 200px; overflow-y: auto; margin-top: 10px;"></div>
                </div>
                <div id="import-images-progress-container" style="margin-top: 10px;"></div>
                <button type="submit" class="create-btn" disabled>导入文件</button>
            </form>
        </div>
    </div>
    <div class="modal" id="download-modal">
        <div class="modal-content">
            <button class="close-btn">×</button>
            <h2 class="modal-title">下载选项</h2>
            <p class="modal-subtitle">选择如何下载选中的图片。</p>
            <div class="download-options">
                <div class="radio-group">
                    <input type="radio" id="download-direct" name="dl_option" value="direct" checked>
                    <label for="download-direct">下载ZIP文件到浏览器</label>
                    <input type="radio" id="download-path" name="dl_option" value="path">
                    <label for="download-path">保存ZIP文件到本地路径（云用户）</label>
                </div>
                <div id="dl-path-container" style="display: none;">
                    <label for="dl-path-input">绝对文件夹路径：</label>
                    <input type="text" id="dl-path-input" placeholder="/绝对/路径/到/保存/文件夹">
                    <small>如果文件夹不存在，将会创建。请不要输入需要root权限的路径。</small>
                </div>
            </div>
            <div class="modal-footer">
                <button class="cancel-btn" id="cancel-download">取消</button>
                <button class="download-btn" id="confirm-download">确认下载</button>
            </div>
        </div>
    </div>
    <div class="modal" id="delete-images-confirm-modal">
        <div class="modal-content danger-modal">
            <div class="modal-header danger-header">
                <div class="header-content">
                    <i class="fas fa-exclamation-triangle danger-icon"></i>
                    <h2>确认删除图片</h2>
                </div>
                <button class="close-btn" id="cancel-delete-images" title="关闭">×</button>
            </div>
            <div class="modal-body">
                <p id="delete-images-message">您确定要删除选中的图片吗？此操作无法撤销。</p>
            </div>
            <div class="modal-footer">
                <button class="cancel-btn" id="cancel-delete-images-footer">Cancel</button>
                <button class="delete-btn" id="confirm-delete-images">Delete</button>
            </div>
        </div>
    </div>
    <div class="modal" id="export-modal">
        <div class="modal-content export-modal-content">
            <button class="close-btn export-close-btn">×</button>
            <div class="export-tabs">
                <!-- Tab Navigation -->
                <div class="tab-nav">
                    <button class="tab-link active" data-tab="format-tab">Format</button>
                    <button class="tab-link" data-tab="split-tab">Split Configuration</button>
                </div>
               
                <!-- Format Selection Tab -->
                <div id="format-tab" class="tab-content active">
                    <h2 class="modal-title">Export Annotations</h2>
                    <p class="modal-subtitle">Select an export format for your annotated images.</p>
                    <div class="format-options">
                        {% if setup_type != "Oriented Bounding Box" %}
                        <div class="format-card" data-format="COCO">
                            <img src="{{ url_for('static', filename='img/coco_logo.png') }}" alt="COCO Format">
                            <h3>COCO</h3>
                            <p>JSON file with images, ideal for object detection and segmentation.</p>
                        </div>
                        <div class="format-card" data-format="PASCAL_VOC">
                            <img src="{{ url_for('static', filename='img/pascal_voc_logo.png') }}" alt="Pascal VOC Format">
                            <h3>Pascal VOC</h3>
                            <p>XML files with images, widely used for object detection.</p>
                        </div>
                        {% endif %}
                        <div class="format-card" data-format="YOLO">
                            <img src="{{ url_for('static', filename='img/yolo_logo.png') }}" alt="YOLO Format">
                            <h3>YOLO</h3>
                            <p>YAML and TXT files with images, optimized for YOLO models.</p>
                        </div>
                        <div class="format-card" data-format="CSV">
                            <img src="{{ url_for('static', filename='img/csv_logo.png') }}" alt="CSV Format">
                            <h3>CSV</h3>
                            <p>Tabular data with images, great for custom analysis.</p>
                        </div>
                    </div>
                    <div class="modal-footer">
                        <button class="cancel-btn" id="cancel-export">Cancel</button>
                        <button class="next-btn" id="next-export-button">Next</button>
                    </div>
                </div>
               
                <!-- Split Configuration Tab -->
                <div id="split-tab" class="tab-content">
                    <h2 class="modal-title">Dataset Split Configuration</h2>
                    <p class="modal-subtitle">Configure how to split your dataset between train, test, and validation sets.</p>
                   
                    <div class="split-options">
                        <div class="split-toggle">
                            <label class="switch">
                                <input type="checkbox" id="enable-splitting" checked>
                                <span class="slider round"></span>
                            </label>
                            <span>Enable Dataset Splitting</span>
                        </div>
                       
                        <div class="split-selection">
                            <div class="split-choice">
                                <input type="checkbox" id="train-split" name="split" value="train" checked disabled>
                                <label for="train-split">Train</label>
                            </div>
                            <div class="split-choice">
                                <input type="checkbox" id="test-split" name="split" value="test">
                                <label for="test-split">Test</label>
                            </div>
                            <div class="split-choice">
                                <input type="checkbox" id="val-split" name="split" value="val">
                                <label for="val-split">Validation</label>
                            </div>
                        </div>
                       
                        <div class="split-ratios">
                            <div class="ratio-control" data-split="train">
                                <label for="train-ratio">Train:</label>
                                <input type="range" id="train-ratio" min="0" max="100" value="70" step="5">
                                <input type="number" id="train-ratio-value" min="0" max="100" value="70">
                                <span>%</span>
                            </div>
                            <div class="ratio-control" data-split="test" style="display: none;">
                                <label for="test-ratio">Test:</label>
                                <input type="range" id="test-ratio" min="0" max="100" value="15" step="5">
                                <input type="number" id="test-ratio-value" min="0" max="100" value="15">
                                <span>%</span>
                            </div>
                            <div class="ratio-control" data-split="val" style="display: none;">
                                <label for="val-ratio">Validation:</label>
                                <input type="range" id="val-ratio" min="0" max="100" value="15" step="5">
                                <input type="number" id="val-ratio-value" min="0" max="100" value="15">
                                <span>%</span>
                            </div>
                        </div>
                       
                        <div class="ratio-summary">
                            <div class="ratio-total">
                                <strong>Total:</strong>
                                <span id="ratio-total-value">100</span>
                                <span>%</span>
                            </div>
                            <div class="ratio-error" id="ratio-error" style="display: none;">
                                <i class="fas fa-exclamation-circle"></i>
                                <span>Ratios must sum to 100%</span>
                            </div>
                        </div>
                        <div class="save-options">
                            <h3>Save Options</h3>
                            <div class="radio-group">
                                <input type="radio" id="export-download" name="export_option" value="download" checked>
                                <label for="export-download">Download ZIP file to browser</label>
                                <input type="radio" id="export-path" name="export_option" value="path">
                                <label for="export-path">Save ZIP file to local path (Cloud users)</label>
                            </div>
                            <div id="export-path-container" style="display: none;">
                                <label for="export-path-input">Absolute folder path:</label>
                                <input type="text" id="export-path-input" placeholder="/absolute/path/to/export/folder">
                                <small>If folder does not exist, it will be created. Please do not enter root priviliged paths.</small>
                            </div>
                        </div>
                    </div>
                   
                    <div class="modal-footer">
                        <button class="back-btn" id="back-export-button">Back</button>
                        <button class="export-btn" id="confirm-export" disabled>Export</button>
                    </div>
                </div>
            </div>
        </div>
    </div>
    <div class="modal" id="ai-preannotator-modal">
        <div class="modal-content ai-modal-content">
            <button class="close-btn">×</button>
            <h2>AI预标注器配置</h2>
            <form id="ai-preannotator-form">
                <div class="form-group">
                    <label>标注模式</label>
                    <div class="mode-buttons">
                        <button type="button" class="mode-btn active" data-mode="zero-shot">零样本检测</button>
                        <button type="button" class="mode-btn" data-mode="custom-model">Ultralytics模型</button>
                    </div>
                    <input type="hidden" id="mode" name="mode" value="zero-shot">
                </div>
                <div id="zero-shot-options" class="form-group">
                    <label>Grounding Dino模型</label>
                    <select id="dino-model">
                        <option value="tiny">Tiny</option>
                        <option value="base">Base</option>
                    </select>
                </div>
                <div id="custom-model-path" class="form-group" style="display: none;">
                    <label>模型路径</label>
                    <input type="text" id="model-path-input" name="model_path" placeholder="输入.pt模型的绝对路径">
                    <p>留空使用默认YOLOv10x</p>
                </div>
                <div class="form-group">
                    <label>处理单元</label>
                    <select id="processing-unit">
                        <option value="cpu">CPU</option>
                        <option value="cuda">GPU</option>
                    </select>
                    <p id="cpu-warning" style="display: none; color: orange;">警告：CPU处理可能需要更长时间。</p>
                </div>
                <div class="form-group">
                    <label>框阈值</label>
                    <input type="number" id="box-threshold" name="box_threshold" min="0" max="1" step="0.01" value="0.2">
                    <p>调整检测敏感度（0到1）</p>
                </div>
                <button type="submit" class="create-btn">应用</button>
            </form>
        </div>
    </div>
    <div class="modal" id="blind-trust-modal">
        <div class="modal-content ai-modal-content">
            <button class="close-btn">×</button>
            <h2>盲信任配置</h2>
            <form id="blind-trust-form">
                <div class="form-group">
                    <label>置信度阈值</label>
                    <input type="number" id="confidence-threshold" name="confidence_threshold" min="0" max="1" step="0.01" value="0.5">
                    <p>预标注被接受为正式标注的最低置信度（0到1）</p>
                </div>
                <button type="submit" class="create-btn">应用</button>
            </form>
        </div>
    </div>
{% endblock %}

{% block scripts %}
<script id="app-config" type="application/json" data-current-user-avatar="{{ current_user_avatar }}">
    {
        "setupType": "{{ setup_type }}",
        "projectName": "{{ project_name }}",
        "classes": {{ classes|tojson }}
    }
</script>
<script type="module" src="/static/js/main.js"></script>
{% endblock %}