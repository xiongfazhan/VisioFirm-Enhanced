#!/usr/bin/env python3
# -*- coding: utf-8 -*-
"""
æ•°æ®é›†ç®¡ç†æ¨¡å—å®Œæ•´æµ‹è¯•å¥—ä»¶
è¿è¡Œæ‰€æœ‰æ•°æ®é›†ç›¸å…³çš„æµ‹è¯•ç”¨ä¾‹
"""

import unittest
import sys
import os
import time
from io import StringIO

# æ·»åŠ é¡¹ç›®æ ¹ç›®å½•åˆ°Pythonè·¯å¾„
sys.path.insert(0, os.path.join(os.path.dirname(__file__), '..'))

# å¯¼å…¥æ‰€æœ‰æµ‹è¯•æ¨¡å—
from test_dataset_model import TestDatasetModel
from test_dataset_service import TestDatasetManager, TestDatasetAnalyzer
from test_dataset_api import TestDatasetAPI, TestDatasetRouteIntegration
from test_dataset_downloader import TestDatasetDownloader, TestDatasetDownloaderIntegration


class ColoredTestResult(unittest.TextTestResult):
    """å¸¦é¢œè‰²è¾“å‡ºçš„æµ‹è¯•ç»“æœç±»"""
    
    def __init__(self, stream, descriptions, verbosity):
        super().__init__(stream, descriptions, verbosity)
        self.success_count = 0
    
    def addSuccess(self, test):
        super().addSuccess(test)
        self.success_count += 1
        if self.verbosity > 1:
            self.stream.write(f"\033[92mâœ“\033[0m ")
            self.stream.writeln(f"PASS: {self.getDescription(test)}")
    
    def addError(self, test, err):
        super().addError(test, err)
        if self.verbosity > 1:
            self.stream.write(f"\033[91mâœ—\033[0m ")
            self.stream.writeln(f"ERROR: {self.getDescription(test)}")
    
    def addFailure(self, test, err):
        super().addFailure(test, err)
        if self.verbosity > 1:
            self.stream.write(f"\033[93mâœ—\033[0m ")
            self.stream.writeln(f"FAIL: {self.getDescription(test)}")
    
    def addSkip(self, test, reason):
        super().addSkip(test, reason)
        if self.verbosity > 1:
            self.stream.write(f"\033[94m-\033[0m ")
            self.stream.writeln(f"SKIP: {self.getDescription(test)} ({reason})")


class ColoredTestRunner(unittest.TextTestRunner):
    """å¸¦é¢œè‰²è¾“å‡ºçš„æµ‹è¯•è¿è¡Œå™¨"""
    
    def __init__(self, **kwargs):
        kwargs['resultclass'] = ColoredTestResult
        super().__init__(**kwargs)
    
    def run(self, test):
        """è¿è¡Œæµ‹è¯•å¹¶è¿”å›ç»“æœ"""
        result = super().run(test)
        
        # è¾“å‡ºè¯¦ç»†çš„æµ‹è¯•ç»“æœ
        self._print_test_summary(result)
        
        return result
    
    def _print_test_summary(self, result):
        """æ‰“å°æµ‹è¯•æ‘˜è¦"""
        print(f"\n{'='*80}")
        print(f"\033[1mæµ‹è¯•ç»“æœæ‘˜è¦\033[0m")
        print(f"{'='*80}")
        
        # åŸºæœ¬ç»Ÿè®¡
        total_tests = result.testsRun
        passed = result.success_count
        failed = len(result.failures)
        errors = len(result.errors)
        skipped = len(result.skipped)
        
        print(f"è¿è¡Œæµ‹è¯•æ€»æ•°: {total_tests}")
        print(f"\033[92mé€šè¿‡: {passed}\033[0m")
        if failed > 0:
            print(f"\033[93må¤±è´¥: {failed}\033[0m")
        if errors > 0:
            print(f"\033[91mé”™è¯¯: {errors}\033[0m")
        if skipped > 0:
            print(f"\033[94mè·³è¿‡: {skipped}\033[0m")
        
        # æˆåŠŸç‡
        if total_tests > 0:
            success_rate = (passed / total_tests) * 100
            print(f"æˆåŠŸç‡: {success_rate:.1f}%")
        
        # å¤±è´¥è¯¦æƒ…
        if result.failures:
            print(f"\n\033[93må¤±è´¥çš„æµ‹è¯•:\033[0m")
            for i, (test, traceback) in enumerate(result.failures, 1):
                print(f"{i}. {test}")
                # æå–å…³é”®é”™è¯¯ä¿¡æ¯
                lines = traceback.split('\n')
                for line in lines:
                    if 'AssertionError' in line:
                        print(f"   â†’ {line.strip()}")
                        break
        
        # é”™è¯¯è¯¦æƒ…
        if result.errors:
            print(f"\n\033[91mé”™è¯¯çš„æµ‹è¯•:\033[0m")
            for i, (test, traceback) in enumerate(result.errors, 1):
                print(f"{i}. {test}")
                # æå–å…³é”®é”™è¯¯ä¿¡æ¯
                lines = traceback.split('\n')
                for line in lines:
                    if any(word in line for word in ['Error:', 'Exception:', 'ImportError:', 'ModuleNotFoundError:']):
                        print(f"   â†’ {line.strip()}")
                        break
        
        # æ€»ä½“ç»“æœ
        overall_success = failed == 0 and errors == 0
        if overall_success:
            print(f"\n\033[1;92mğŸ‰ æ‰€æœ‰æµ‹è¯•é€šè¿‡ï¼\033[0m")
        else:
            print(f"\n\033[1;91mâŒ æœ‰æµ‹è¯•å¤±è´¥ï¼Œè¯·æ£€æŸ¥ä¸Šè¿°é”™è¯¯ä¿¡æ¯\033[0m")
        
        print(f"{'='*80}")


def create_test_suite():
    """åˆ›å»ºå®Œæ•´çš„æµ‹è¯•å¥—ä»¶"""
    suite = unittest.TestSuite()
    
    # å®šä¹‰æµ‹è¯•ç”¨ä¾‹ç»„
    test_cases = [
        # æ•°æ®é›†æ¨¡å‹æµ‹è¯•
        ('æ•°æ®é›†æ¨¡å‹', TestDatasetModel),
        
        # æ•°æ®é›†æœåŠ¡æµ‹è¯•
        ('æ•°æ®é›†ç®¡ç†æœåŠ¡', TestDatasetManager),
        ('æ•°æ®é›†åˆ†ææœåŠ¡', TestDatasetAnalyzer),
        
        # æ•°æ®é›†APIæµ‹è¯•
        ('æ•°æ®é›†API', TestDatasetAPI),
        ('æ•°æ®é›†è·¯ç”±é›†æˆ', TestDatasetRouteIntegration),
        
        # æ•°æ®é›†ä¸‹è½½å™¨æµ‹è¯•
        ('æ•°æ®é›†ä¸‹è½½å™¨', TestDatasetDownloader),
        ('ä¸‹è½½å™¨é›†æˆæµ‹è¯•', TestDatasetDownloaderIntegration),
    ]
    
    # æ·»åŠ æµ‹è¯•ç”¨ä¾‹åˆ°å¥—ä»¶
    loader = unittest.TestLoader()
    for name, test_class in test_cases:
        print(f"åŠ è½½æµ‹è¯•ç»„: {name}")
        suite.addTests(loader.loadTestsFromTestCase(test_class))
    
    return suite


def run_specific_test_group(group_name):
    """è¿è¡Œç‰¹å®šçš„æµ‹è¯•ç»„"""
    test_groups = {
        'model': [TestDatasetModel],
        'service': [TestDatasetManager, TestDatasetAnalyzer],
        'api': [TestDatasetAPI, TestDatasetRouteIntegration],
        'downloader': [TestDatasetDownloader, TestDatasetDownloaderIntegration],
    }
    
    if group_name not in test_groups:
        print(f"æœªçŸ¥çš„æµ‹è¯•ç»„: {group_name}")
        print(f"å¯ç”¨çš„æµ‹è¯•ç»„: {', '.join(test_groups.keys())}")
        return False
    
    suite = unittest.TestSuite()
    loader = unittest.TestLoader()
    
    for test_class in test_groups[group_name]:
        suite.addTests(loader.loadTestsFromTestCase(test_class))
    
    runner = ColoredTestRunner(verbosity=2)
    result = runner.run(suite)
    
    return len(result.failures) == 0 and len(result.errors) == 0


def run_all_tests():
    """è¿è¡Œæ‰€æœ‰æµ‹è¯•"""
    print("\033[1;36m" + "="*80 + "\033[0m")
    print("\033[1;36m" + "VisioFirm æ•°æ®é›†ç®¡ç†æ¨¡å—æµ‹è¯•å¥—ä»¶".center(80) + "\033[0m")
    print("\033[1;36m" + "="*80 + "\033[0m")
    
    start_time = time.time()
    
    # åˆ›å»ºå¹¶è¿è¡Œæµ‹è¯•å¥—ä»¶
    suite = create_test_suite()
    runner = ColoredTestRunner(verbosity=2)
    result = runner.run(suite)
    
    end_time = time.time()
    
    # è¾“å‡ºæ‰§è¡Œæ—¶é—´
    duration = end_time - start_time
    print(f"\næ€»æ‰§è¡Œæ—¶é—´: {duration:.2f} ç§’")
    
    # è¿”å›æµ‹è¯•æ˜¯å¦å…¨éƒ¨é€šè¿‡
    return len(result.failures) == 0 and len(result.errors) == 0


def main():
    """ä¸»å‡½æ•°"""
    import argparse
    
    parser = argparse.ArgumentParser(description='VisioFirm æ•°æ®é›†ç®¡ç†æ¨¡å—æµ‹è¯•å¥—ä»¶')
    parser.add_argument(
        '--group', '-g',
        choices=['model', 'service', 'api', 'downloader'],
        help='è¿è¡Œç‰¹å®šçš„æµ‹è¯•ç»„'
    )
    parser.add_argument(
        '--verbose', '-v',
        action='store_true',
        help='è¯¦ç»†è¾“å‡ºæ¨¡å¼'
    )
    parser.add_argument(
        '--quiet', '-q',
        action='store_true',
        help='å®‰é™æ¨¡å¼ï¼Œåªè¾“å‡ºç»“æœ'
    )
    
    args = parser.parse_args()
    
    # è®¾ç½®è¯¦ç»†ç¨‹åº¦
    if args.quiet:
        verbosity = 0
    elif args.verbose:
        verbosity = 2
    else:
        verbosity = 1
    
    # è¿è¡Œæµ‹è¯•
    try:
        if args.group:
            success = run_specific_test_group(args.group)
        else:
            success = run_all_tests()
        
        # æ ¹æ®ç»“æœè®¾ç½®é€€å‡ºç 
        sys.exit(0 if success else 1)
        
    except KeyboardInterrupt:
        print("\n\n\033[93mæµ‹è¯•è¢«ç”¨æˆ·ä¸­æ–­\033[0m")
        sys.exit(130)
    except Exception as e:
        print(f"\n\n\033[91mæµ‹è¯•è¿è¡Œæ—¶å‘ç”Ÿé”™è¯¯: {e}\033[0m")
        sys.exit(1)


if __name__ == '__main__':
    main()